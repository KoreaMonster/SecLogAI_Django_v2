<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecLogAI - MVP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- ë§ˆí¬ë‹¤ìš´ ë Œë”ë§ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
            background-color: #f0f2f5;
        }
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        button:hover {
            background-color: #2563eb;
            transition: background-color 0.3s ease;
        }
        .analysis-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            transition: all 0.3s ease;
        }
        .hidden {
            display: none;
        }

        /* Chatbot Styles */
        .chatbot-container {
            max-width: 900px;
            margin: 0 auto;
        }
        .chatbot-messages {
            height: 500px;
            overflow-y: auto;
            margin-bottom: 1rem;
            padding: 1rem;
        }
        .message {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1rem;
            align-items: flex-start;
        }
        .message.user {
            flex-direction: row-reverse;
        }
        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .message.assistant .message-avatar {
            background-color: #dbeafe;
            color: #2563eb;
        }
        .message.user .message-avatar {
            background-color: #dcfce7;
            color: #16a34a;
        }
        .message-bubble {
            max-width: 70%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            line-height: 1.6;
            position: relative;
        }
        .message.assistant .message-bubble {
            background-color: #f3f4f6;
            color: #1f2937;
            border-bottom-left-radius: 0.25rem;
        }
        /* ë§ˆí¬ë‹¤ìš´ ìŠ¤íƒ€ì¼ë§ */
        .message-bubble h1, .message-bubble h2, .message-bubble h3 {
            font-weight: bold;
            margin-top: 0.75rem;
            margin-bottom: 0.5rem;
        }
        .message-bubble h1 { font-size: 1.25rem; }
        .message-bubble h2 { font-size: 1.125rem; }
        .message-bubble h3 { font-size: 1rem; }
        .message-bubble p {
            margin-bottom: 0.5rem;
        }
        .message-bubble ul, .message-bubble ol {
            margin-left: 1.5rem;
            margin-bottom: 0.75rem;
        }
        .message-bubble li {
            margin-bottom: 0.25rem;
        }
        .message-bubble strong {
            font-weight: 600;
            color: #1f2937;
        }
        .message-bubble code {
            background-color: #e5e7eb;
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
        }
        .message-bubble pre {
            background-color: #1f2937;
            color: #f9fafb;
            padding: 0.75rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin: 0.5rem 0;
        }
        .message-bubble pre code {
            background-color: transparent;
            color: inherit;
            padding: 0;
        }
        /* ë³µì‚¬ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .copy-button {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: rgba(255, 255, 255, 0.9);
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.25rem 0.5rem;
            cursor: pointer;
            font-size: 0.75rem;
            color: #6b7280;
            transition: all 0.2s;
        }
        .copy-button:hover {
            background-color: #ffffff;
            color: #2563eb;
            border-color: #2563eb;
        }
        .copy-button.copied {
            color: #16a34a;
            border-color: #16a34a;
        }
        .message.user .message-bubble {
            background-color: #2563eb;
            color: white;
            border-bottom-right-radius: 0.25rem;
        }
        .typing-indicator {
            display: flex;
            gap: 0.25rem;
            padding: 0.75rem 1rem;
        }
        .typing-dot {
            width: 8px;
            height: 8px;
            background-color: #9ca3af;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }
        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.7; }
            30% { transform: translateY(-10px); opacity: 1; }
        }
    </style>
</head>
<body class="font-sans">

    <header class="bg-white shadow-md">
        <nav class="main-container flex justify-between items-center py-4">
            <h1 class="text-2xl font-bold text-gray-800">
                <i class="fas fa-shield-halved text-blue-600"></i>
                SecLogAI
            </h1>
        </nav>
    </header>

    <main class="main-container">

        <div id="loading-spinner" class="hidden text-center py-20">
            <i class="fas fa-spinner fa-spin text-blue-600 text-4xl"></i>
            <p class="mt-4 text-gray-600">ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</p>
        </div>

        <!-- í™ˆ í˜ì´ì§€ -->
        <div id="home-page">
            <div class="card mb-8">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">ìƒˆë¡œìš´ ë¡œê·¸ íŒŒì¼ ë¶„ì„í•˜ê¸°</h2>
                <form id="upload-form">
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                        <input type="file" id="file-input" class="hidden" required>
                        <label for="file-input" class="cursor-pointer text-blue-600 font-semibold">
                            <i class="fas fa-upload mr-2"></i>
                            <span id="upload-instruction">íŒŒì¼ì„ ì„ íƒí•˜ê±°ë‚˜ ì—¬ê¸°ì— ë“œë˜ê·¸ ì•¤ ë“œë¡­í•˜ì„¸ìš”.</span>
                        </label>
                        <p id="file-name-display" class="mt-2 text-gray-500"></p>
                    </div>
                    <button type="submit" class="mt-4 w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition">
                        ì—…ë¡œë“œ ë° ë¶„ì„ ì‹œì‘
                    </button>
                </form>
            </div>

            <div>
                <h2 class="text-xl font-semibold text-gray-700 mb-4">ë¶„ì„í•  ë¡œê·¸ íŒŒì¼ ì„ íƒ</h2>
                <div id="file-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>
        </div>

        <!-- ë¶„ì„ í—ˆë¸Œ -->
        <div id="analysis-page" class="hidden">
            <button onclick="showPage('home-page')" class="mb-6 bg-gray-200 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-300 transition">
                <i class="fas fa-arrow-left mr-2"></i>
                íŒŒì¼ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
            </button>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="card">
                    <h2 class="text-2xl font-bold text-gray-800">
                        ë¶„ì„ íŒŒì¼: <span id="selected-file-name" class="text-blue-600"></span>
                    </h2>
                    <p class="mt-2 text-gray-600">ì•„ë˜ì—ì„œ ìˆ˜í–‰í•  ë¶„ì„ ëª¨ë¸ì„ ì„ íƒí•˜ì„¸ìš”.</p>
                </div>

                <div class="card">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">íŒŒì¼ ì •ë³´</h3>
                    <div id="file-description">
                        <p class="text-sm text-gray-600 mb-2">
                            <strong>ë¡œê·¸ ìœ í˜•:</strong> <span id="log-type">ë³´ì•ˆ ì´ë²¤íŠ¸ ë¡œê·¸</span>
                        </p>
                        <p class="text-sm text-gray-600 mb-2">
                            <strong>ì´ ë¡œê·¸ ìˆ˜:</strong> <span id="total-logs">106ê°œ</span>
                        </p>
                        <p class="text-sm text-gray-600 mb-3">
                            <strong>ë¡œê·¸ ì˜ˆì œ:</strong>
                        </p>
                        <div class="bg-gray-100 p-3 rounded text-xs font-mono">
                            <span id="log-example">Dec 15 08:30:15 webserver01 httpd: 192.168.1.100 - - [15/Dec/2023:08:30:15 +0000] "GET /admin.php"</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div onclick="runAnalysis('basic-stats')" class="card text-center cursor-pointer analysis-card">
                    <i class="fas fa-chart-pie text-3xl text-green-500 mb-3"></i>
                    <h3 class="font-semibold text-lg">ê¸°ë³¸ í†µê³„ ë¶„ì„</h3>
                </div>
                <div onclick="runAnalysis('security-threat')" class="card text-center cursor-pointer analysis-card">
                    <i class="fas fa-exclamation-triangle text-3xl text-red-500 mb-3"></i>
                    <h3 class="font-semibold text-lg">ë³´ì•ˆ ìœ„í˜‘ ë¶„ì„</h3>
                </div>
                <div onclick="runAnalysis('anomaly')" class="card text-center cursor-pointer analysis-card">
                    <i class="fas fa-search text-3xl text-yellow-500 mb-3"></i>
                    <h3 class="font-semibold text-lg">ì´ìƒ í–‰ìœ„ ë¶„ì„</h3>
                </div>
                <div onclick="runAnalysis('correlation')" class="card text-center cursor-pointer analysis-card">
                    <i class="fas fa-link text-3xl text-purple-500 mb-3"></i>
                    <h3 class="font-semibold text-lg">ìƒê´€ê´€ê³„ ë¶„ì„</h3>
                </div>
                <div onclick="runAnalysis('predictive')" class="card text-center cursor-pointer analysis-card">
                    <i class="fas fa-brain text-3xl text-indigo-500 mb-3"></i>
                    <h3 class="font-semibold text-lg">ì˜ˆì¸¡ ë¶„ì„</h3>
                </div>
                <div onclick="openChatbot()" class="card text-center cursor-pointer analysis-card">
                    <i class="fas fa-robot text-3xl text-cyan-500 mb-3"></i>
                    <h3 class="font-semibold text-lg">AI ChatBot</h3>
                </div>
            </div>
        </div>

        <!-- ë¶„ì„ ê²°ê³¼ -->
        <div id="result-page" class="hidden">
            <button id="back-to-analysis" onclick="showPage('analysis-page')" class="mb-6 bg-gray-200 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-300 transition">
                <i class="fas fa-arrow-left mr-2"></i>
                ë¶„ì„ í—ˆë¸Œë¡œ ëŒì•„ê°€ê¸°
            </button>
            <div class="card">
                <h2 id="result-title" class="text-2xl font-bold text-gray-800 mb-4"></h2>
                <pre id="result-content" class="whitespace-pre-wrap bg-gray-100 p-4 rounded-lg font-mono text-sm"></pre>
            </div>
        </div>

        <!-- Chatbot í˜ì´ì§€ -->
        <div id="chatbot-page" class="hidden">
            <button onclick="showPage('analysis-page')" class="mb-6 bg-gray-200 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-300 transition">
                <i class="fas fa-arrow-left mr-2"></i>
                ë¶„ì„ í—ˆë¸Œë¡œ ëŒì•„ê°€ê¸°
            </button>

            <div class="chatbot-container">
                <div class="card mb-4">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-robot text-3xl text-cyan-500"></i>
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">AI ë³´ì•ˆ ë¶„ì„ ì–´ì‹œìŠ¤í„´íŠ¸</h2>
                            <p class="text-sm text-gray-600">íŒŒì¼: <span id="chatbot-file-name">--</span></p>
                        </div>
                    </div>
                </div>

                <div class="card chatbot-messages" id="chatbot-messages">
                    <div class="message assistant">
                        <div class="message-avatar">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="message-bubble">
                            <p>ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” ë³´ì•ˆ ë¡œê·¸ ë¶„ì„ ì „ë¬¸ AI ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤. ë¡œê·¸ ë°ì´í„°ì— ëŒ€í•´ ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”!</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <form id="chatbot-form" class="flex gap-3">
                        <input
                            type="text"
                            id="chatbot-input"
                            class="flex-1 px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                            placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                            autocomplete="off"
                            required
                        >
                        <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <script>
        const API_BASE_URL = '';
        let selectedFileId = null;
        let selectedFileName = null;
        let chatSessionId = null;

        const pages = ['home-page', 'analysis-page', 'result-page', 'chatbot-page', 'loading-spinner'];

        function showPage(pageId) {
            pages.forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(pageId).classList.remove('hidden');
        }

        async function fetchFiles() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/logs/files/`);
                if (!response.ok) throw new Error('ì„œë²„ì—ì„œ íŒŒì¼ ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');

                const files = await response.json();
                const fileListElement = document.getElementById('file-list');
                fileListElement.innerHTML = '';

                if (files.length === 0) {
                    fileListElement.innerHTML = `<p class="text-gray-500 col-span-full text-center">ì—…ë¡œë“œëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ìƒˆ ë¡œê·¸ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</p>`;
                } else {
                    files.forEach(file => {
                        const fileCard = `
                            <div class="card cursor-pointer relative" onclick="selectFile(${file.id}, '${file.name}')">
                                <div class="absolute top-2 right-2">
                                    <button class="text-red-600 hover:text-red-800 p-1 rounded-full hover:bg-red-100 transition" onclick="event.stopPropagation(); deleteFile(${file.id})">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div class="flex items-center pr-8">
                                    <i class="fas fa-file-alt text-2xl text-gray-400 mr-4"></i>
                                    <div>
                                        <h3 class="font-semibold text-gray-800">${file.name}</h3>
                                        <p class="text-sm text-gray-500">${new Date(file.uploaded_at).toLocaleString()}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                        fileListElement.innerHTML += fileCard;
                    });
                }
            } catch (error) {
                console.error('Error fetching files:', error);
                alert(error.message);
            }
        }

        async function loadFileInfo(fileId) {
            try {
                showPage('loading-spinner');

                // íŒŒì¼ ìƒì„¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const response = await fetch(`${API_BASE_URL}/api/logs/files/${fileId}/`);
                if (!response.ok) throw new Error('íŒŒì¼ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨');

                const data = await response.json();
                const stats = data.stats;

                // ë¡œê·¸ ìœ í˜• í‘œì‹œ
                const logTypes = Object.keys(stats.log_type_distribution || {});
                document.getElementById('log-type').innerText =
                    logTypes.length > 0 ? logTypes.join(', ') : 'ì•Œ ìˆ˜ ì—†ìŒ';

                // ì´ ë¡œê·¸ ìˆ˜ í‘œì‹œ
                document.getElementById('total-logs').innerText =
                    `${stats.total_entries || 0}ê°œ`;

                // ë¡œê·¸ ì˜ˆì œ ê°€ì ¸ì˜¤ê¸°
                const previewResponse = await fetch(`${API_BASE_URL}/api/logs/files/${fileId}/preview/`);
                if (previewResponse.ok) {
                    const previewData = await previewResponse.json();
                    if (previewData.preview && previewData.preview.length > 0) {
                        document.getElementById('log-example').innerText =
                            previewData.preview[0].raw_log || 'ì˜ˆì œ ì—†ìŒ';
                    } else {
                        document.getElementById('log-example').innerText = 'ì˜ˆì œ ì—†ìŒ';
                    }
                }

            } catch (error) {
                console.error('íŒŒì¼ ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
                alert('íŒŒì¼ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                showPage('home-page');
            }
        }
        async function deleteFile(fileId) {
            if (!confirm('ì´ íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken');

                const response = await fetch(`${API_BASE_URL}/api/logs/files/${fileId}/delete/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) throw new Error('íŒŒì¼ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');

                alert('íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                fetchFiles();
            } catch (error) {
                console.error('Error deleting file:', error);
                alert(error.message);
            }
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        async function uploadFile(event) {
            event.preventDefault();
            const fileInput = document.getElementById('file-input');
            if (fileInput.files.length === 0) {
                alert('ì—…ë¡œë“œí•  íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('file', file);
            formData.append('name', file.name);

            showPage('loading-spinner');

            try {
                const csrfToken = getCookie('csrftoken');

                const response = await fetch(`${API_BASE_URL}/api/logs/upload/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken
                    },
                    body: formData,
                });

                if (!response.ok) throw new Error('íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');

                const result = await response.json();
                alert(`íŒŒì¼ ì—…ë¡œë“œ ë° ì²˜ë¦¬ ì„±ê³µ!\n- ì²˜ë¦¬ëœ ë¡œê·¸: ${result.processed_entries}ê°œ`);

                selectFile(result.log_file_id, file.name);
                fetchFiles();

            } catch (error) {
                console.error('Error uploading file:', error);
                alert(error.message);
                showPage('home-page');
            }
        }

        async function runAnalysis(analysisType) {
            if (!selectedFileId) {
                alert('ë¶„ì„í•  íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }

            const analysisEndpoints = {
                'basic-stats': `${API_BASE_URL}/api/analysis/basic-stats/`,
                'security-threat': `${API_BASE_URL}/api/analysis/security-threat/`,
                'anomaly': `${API_BASE_URL}/api/analysis/anomaly/`,
                'correlation': `${API_BASE_URL}/api/analysis/correlation/`,
                'predictive': `${API_BASE_URL}/api/analysis/predictive/`,
            };

            const url = analysisEndpoints[analysisType];
            if (!url) {
                alert('ì•Œ ìˆ˜ ì—†ëŠ” ë¶„ì„ ìœ í˜•ì…ë‹ˆë‹¤.');
                return;
            }

            showPage('loading-spinner');

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`'${analysisType}' ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.`);

                const result = await response.json();

                const titleMap = {
                    'basic-stats': 'ê¸°ë³¸ í†µê³„ ë¶„ì„ ê²°ê³¼',
                    'security-threat': 'ë³´ì•ˆ ìœ„í˜‘ ë¶„ì„ ê²°ê³¼',
                    'anomaly': 'ì´ìƒ í–‰ìœ„ ë¶„ì„ ê²°ê³¼',
                    'correlation': 'ìƒê´€ê´€ê³„ ë¶„ì„ ê²°ê³¼',
                    'predictive': 'ì˜ˆì¸¡ ë¶„ì„ ê²°ê³¼',
                };

                document.getElementById('result-title').innerText = titleMap[analysisType];

                // ë¶„ì„ ê²°ê³¼ë¥¼ ì‚¬ëŒì´ ì½ê¸° ì¢‹ê²Œ í¬ë§·íŒ…
                let formattedText = '';

                if (analysisType === 'basic-stats') {
                    formattedText = `${result.overview || ''}\n\n${result.time_analysis || ''}`;
                } else if (analysisType === 'security-threat') {
                    formattedText = `${result.overview || ''}\n\n`;
                    if (result.threat_patterns) {
                        formattedText += `ğŸš¨ ìœ„í˜‘ íŒ¨í„´ ìš”ì•½:\n`;
                        for (const [key, value] of Object.entries(result.threat_patterns)) {
                            formattedText += `  - ${key}: ${value}ê±´\n`;
                        }
                    }
                    if (result.suspicious_ips && result.suspicious_ips.length > 0) {
                        formattedText += `\nâš ï¸ ì˜ì‹¬ìŠ¤ëŸ¬ìš´ IP (ìƒìœ„ 5ê°œ):\n`;
                        result.suspicious_ips.forEach((ip, index) => {
                            formattedText += `  ${index + 1}. ${ip.ip || ip}: ${ip.count || ip.threat_score}ê±´\n`;
                        });
                    }
                } else if (analysisType === 'anomaly') {
                    formattedText = `${result.overview || ''}\n\n`;
                    formattedText += `${result.volume_summary || ''}\n\n`;
                    formattedText += `${result.behavioral_summary || ''}\n\n`;
                    formattedText += `ì´ ì´ìƒ í•­ëª©: ${result.total_anomalies || 0}ê±´`;
                } else if (analysisType === 'correlation') {
                    formattedText = `${result.overview || ''}\n\n`;
                    formattedText += `${result.temporal_summary || ''}\n\n`;
                    if (result.strong_correlations && result.strong_correlations.length > 0) {
                        formattedText += `ê°•í•œ ìƒê´€ê´€ê³„ ë°œê²¬:\n`;
                        result.strong_correlations.forEach(corr => {
                            formattedText += `  - ${corr.description || JSON.stringify(corr)}\n`;
                        });
                    }
                } else if (analysisType === 'predictive') {
                    formattedText = `${result.overview || ''}\n\n`;
                    formattedText += `${result.traffic_summary || ''}\n\n`;
                    formattedText += `${result.threat_summary || ''}`;
                } else {
                    // ê¸°ë³¸: JSON í¬ë§·ìœ¼ë¡œ í‘œì‹œ
                    formattedText = JSON.stringify(result, null, 2);
                }

                document.getElementById('result-content').innerText = formattedText;
                showPage('result-page');

            } catch (error) {
                console.error('Error running analysis:', error);
                alert(error.message);
                showPage('analysis-page');
            }
        }

        async function selectFile(fileId, fileName) {
            selectedFileId = fileId;
            selectedFileName = fileName;
            document.getElementById('selected-file-name').innerText = fileName;

            // íŒŒì¼ ì •ë³´ë¥¼ ë™ì ìœ¼ë¡œ ë¡œë“œ
            await loadFileInfo(fileId);

            showPage('analysis-page');
        }

        // Chatbot ì—´ê¸°
        function openChatbot() {
            if (!selectedFileId) {
                alert('ì±—ë´‡ì„ ì‚¬ìš©í•˜ë ¤ë©´ ë¨¼ì € íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            document.getElementById('chatbot-file-name').innerText = selectedFileName || 'ì•Œ ìˆ˜ ì—†ìŒ';

            // ì±—ë´‡ ë©”ì‹œì§€ ì´ˆê¸°í™” (í™˜ì˜ ë©”ì‹œì§€ë§Œ ë‚¨ê¹€)
            const chatMessages = document.getElementById('chatbot-messages');
            chatMessages.innerHTML = `
                <div class="message assistant">
                    <div class="message-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="message-bubble">
                        <p>ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” ë³´ì•ˆ ë¡œê·¸ ë¶„ì„ ì „ë¬¸ AI ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤. ë¡œê·¸ ë°ì´í„°ì— ëŒ€í•´ ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”!</p>
                    </div>
                </div>
            `;

            chatSessionId = null;
            showPage('chatbot-page');
        }

        // Chatbot ë©”ì‹œì§€ ì „ì†¡
        async function sendChatMessage(event) {
            event.preventDefault();

            const input = document.getElementById('chatbot-input');
            const message = input.value.trim();

            if (!message) return;

            // ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ
            addChatMessage('user', message);
            input.value = '';

            // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° í‘œì‹œ
            showTypingIndicator();

            try {
                const csrfToken = getCookie('csrftoken');
                const response = await fetch(`${API_BASE_URL}/api/chatbot/message/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        message: message,
                        session_id: chatSessionId,
                        log_file_id: selectedFileId
                    })
                });

                if (!response.ok) throw new Error('ì±—ë´‡ ì‘ë‹µ ì‹¤íŒ¨');

                const result = await response.json();

                // ì„¸ì…˜ ID ì €ì¥
                if (!chatSessionId) {
                    chatSessionId = result.session_id;
                }

                // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° ì œê±°
                hideTypingIndicator();

                // AI ì‘ë‹µ í‘œì‹œ
                addChatMessage('assistant', result.assistant_message);

            } catch (error) {
                console.error('Chatbot error:', error);
                hideTypingIndicator();
                addChatMessage('assistant', 'ì£„ì†¡í•©ë‹ˆë‹¤. ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        }

        function addChatMessage(role, content) {
            const chatMessages = document.getElementById('chatbot-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            const avatarIcon = role === 'user' ? 'fa-user' : 'fa-robot';

            // ë§ˆí¬ë‹¤ìš´ì„ HTMLë¡œ ë³€í™˜ (assistant ë©”ì‹œì§€ë§Œ)
            let messageContent;
            if (role === 'assistant') {
                // marked.jsë¡œ ë§ˆí¬ë‹¤ìš´ íŒŒì‹±
                messageContent = marked.parse(content);
            } else {
                // ì‚¬ìš©ì ë©”ì‹œì§€ëŠ” ê·¸ëŒ€ë¡œ í‘œì‹œ (HTML ì´ìŠ¤ì¼€ì´í”„)
                messageContent = `<p>${escapeHtml(content)}</p>`;
            }

            messageDiv.innerHTML = `
                <div class="message-avatar">
                    <i class="fas ${avatarIcon}"></i>
                </div>
                <div class="message-bubble">
                    ${messageContent}
                    ${role === 'assistant' ? `
                        <button class="copy-button" onclick="copyMessage(this, ${JSON.stringify(content).replace(/"/g, '&quot;')})">
                            <i class="fas fa-copy"></i> ë³µì‚¬
                        </button>
                    ` : ''}
                </div>
            `;

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showTypingIndicator() {
            const chatMessages = document.getElementById('chatbot-messages');
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typing-indicator';
            typingDiv.className = 'message assistant';
            typingDiv.innerHTML = `
                <div class="message-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="message-bubble">
                    <div class="typing-indicator">
                        <span class="typing-dot"></span>
                        <span class="typing-dot"></span>
                        <span class="typing-dot"></span>
                    </div>
                </div>
            `;
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                indicator.remove();
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        function copyMessage(button, content) {
            // í´ë¦½ë³´ë“œì— ë³µì‚¬
            navigator.clipboard.writeText(content).then(() => {
                // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
                const originalHTML = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i> ë³µì‚¬ë¨';
                button.classList.add('copied');

                // 2ì´ˆ í›„ ì›ë˜ëŒ€ë¡œ
                setTimeout(() => {
                    button.innerHTML = originalHTML;
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
                alert('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const fileInput = document.getElementById('file-input');
            const uploadInstruction = document.getElementById('upload-instruction');

            fileInput.addEventListener('change', (event) => {
                if (event.target.files.length > 0) {
                    uploadInstruction.style.display = 'none';
                    document.getElementById('file-name-display').innerText = event.target.files[0].name;
                } else {
                    uploadInstruction.style.display = 'inline';
                    document.getElementById('file-name-display').innerText = '';
                }
            });

            showPage('home-page');
            fetchFiles();
            document.getElementById('upload-form').addEventListener('submit', uploadFile);
            document.getElementById('chatbot-form').addEventListener('submit', sendChatMessage);
        });
    </script>
</body>
</html>